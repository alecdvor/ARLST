<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amateur Radio Exam Study Game - v0.1.2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            touch-action: manipulation;
        }
        /* Custom checkbox style */
        .chapter-checkbox:checked + label, .option-checkbox:checked + label {
            background-color: #3b82f6; /* Tailwind blue-500 */
            border-color: #3b82f6;
            color: white;
        }
        .mode-button.selected {
             background-color: #3b82f6;
             color: white;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 flex items-center justify-center min-h-screen p-4">

    <!-- Main Selection Screen -->
    <div id="selection-container" class="w-full max-w-2xl mx-auto bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 md:p-8">
        <h1 class="text-2xl md:text-3xl font-bold text-center text-gray-800 dark:text-white mb-6">Choose a Study Mode</h1>
        
        <!-- Mode Selection Buttons -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <button id="mode-study-btn" class="mode-button w-full text-center p-4 rounded-lg border border-gray-300 dark:border-gray-600 cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                <span class="text-lg font-bold">Study by Chapter</span>
                <p class="text-sm text-gray-500 dark:text-gray-400">Focus on specific topics.</p>
            </button>
            <button id="mode-exam-btn" class="mode-button w-full text-center p-4 rounded-lg border border-gray-300 dark:border-gray-600 cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                <span class="text-lg font-bold">Practice Exam</span>
                <p class="text-sm text-gray-500 dark:text-gray-400">35 random questions.</p>
            </button>
        </div>

        <!-- Study by Chapter Options (Initially Hidden) -->
        <div id="study-options" class="hidden">
            <p class="text-center text-gray-500 dark:text-gray-400 mb-6">Choose one or more chapters to begin.</p>
            <div id="chapter-list" class="grid grid-cols-2 sm:grid-cols-3 gap-4 mb-6">
                <!-- Chapter checkboxes will be dynamically inserted here -->
            </div>
            <div class="flex items-center justify-center mb-8">
                <input type="checkbox" id="randomize-questions" name="randomize" class="hidden option-checkbox" checked>
                <label for="randomize-questions" class="flex items-center justify-center w-auto px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                    <span>Randomize Questions</span>
                </label>
            </div>
        </div>

        <!-- Practice Exam Options (Initially Hidden) -->
        <div id="exam-options" class="hidden text-center">
            <p class="text-gray-600 dark:text-gray-300 mb-6">Take a simulated General class exam with 35 randomly selected questions from the entire pool. You need 26 correct answers to pass. Your time will be recorded.</p>
        </div>

        <button id="start-btn" class="w-full bg-blue-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 dark:focus:ring-blue-800 transition-all duration-300 disabled:bg-gray-400 dark:disabled:bg-gray-600 disabled:cursor-not-allowed" disabled>
            Start
        </button>
    </div>

    <!-- Main Game Screen (Phaser will inject canvas here) -->
    <div id="game-container" class="w-full max-w-2xl mx-auto hidden"></div>

    <!-- Final Score Screen -->
    <div id="score-container" class="w-full max-w-2xl mx-auto bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 md:p-8 hidden"></div>


    <!-- Chapter Question Files -->
    <script src="questions/g1_questions.js"></script>
    <script src="questions/g2_questions.js"></script>
    <script src="questions/g3_questions.js"></script>
    <script src="questions/g4_questions.js"></script>
    <script src="questions/g5_questions.js"></script>
    <script src="questions/g6_questions.js"></script>
    <script src="questions/g7_questions.js"></script>
    <script src="questions/g8_questions.js"></script>
    <script src="questions/g9_questions.js"></script>
    <script src="questions/g10_questions.js"></script>

    <script>
        window.addEventListener('load', () => {
        setTimeout(() => { 
            // ----- DATA -----
            const CHAPTER_DATA = [];
            const potentialChapters = [
                { id: 1, name: 'g1_questions', title: "Commission's Rules" },
                { id: 2, name: 'g2_questions', title: "Operating Procedures" },
                { id: 3, name: 'g3_questions', title: "Radio Wave Propagation" },
                { id: 4, name: 'g4_questions', title: "Amateur Radio Practices" },
                { id: 5, name: 'g5_questions', title: "Electrical Principles" },
                { id: 6, name: 'g6_questions', title: "Circuit Components" },
                { id: 7, name: 'g7_questions', title: "Practical Circuits" },
                { id: 8, name: 'g8_questions', title: "Signals and Emissions" },
                { id: 9, name: 'g9_questions', title: "Antennas and Feed Lines" },
                { id: 10, name: 'g10_questions', title: "Electrical Safety" }
            ];

            potentialChapters.forEach(chapter => {
                if (typeof window[chapter.name] !== 'undefined' && window[chapter.name].questions) {
                    CHAPTER_DATA.push({ id: chapter.id, varName: chapter.name, data: window[chapter.name], title: chapter.title });
                }
            });

            // ----- DOM ELEMENT REFERENCES -----
            const selectionContainer = document.getElementById('selection-container');
            const gameContainer = document.getElementById('game-container');
            const scoreContainer = document.getElementById('score-container');
            const chapterList = document.getElementById('chapter-list');
            const startBtn = document.getElementById('start-btn');
            const randomizeCheckbox = document.getElementById('randomize-questions');
            const modeStudyBtn = document.getElementById('mode-study-btn');
            const modeExamBtn = document.getElementById('mode-exam-btn');
            const studyOptions = document.getElementById('study-options');
            const examOptions = document.getElementById('exam-options');

            // ----- GLOBAL GAME STATE -----
            let allQuestions = [];
            let gameInstance = null;
            let chapterScores = {};
            let missedQuestions = [];
            let overallScore = { correct: 0, attempted: 0 };
            let gameMode = null; // 'study' or 'exam'
            let examStartTime = null;

            // ----- INITIALIZATION -----
            function initializeChapterSelection() {
                CHAPTER_DATA.forEach(chapter => {
                    const div = document.createElement('div');
                    const input = document.createElement('input');
                    input.type = 'checkbox';
                    input.id = `chapter-${chapter.id}`;
                    input.name = 'chapter';
                    input.value = chapter.id;
                    input.classList.add('hidden', 'chapter-checkbox');

                    const label = document.createElement('label');
                    label.htmlFor = `chapter-${chapter.id}`;
                    label.textContent = `Chapter ${chapter.id}`;
                    label.classList.add('block', 'w-full', 'text-center', 'p-4', 'rounded-lg', 'border', 'border-gray-300', 'dark:border-gray-600', 'cursor-pointer', 'hover:bg-gray-100', 'dark:hover:bg-gray-700', 'transition-colors');
                    
                    div.appendChild(input);
                    div.appendChild(label);
                    chapterList.appendChild(div);
                });
            }

            // ----- PHASER GAME SCENE -----
            class GameScene extends Phaser.Scene {
                constructor() { super('GameScene'); }
                preload() { this.load.image('figureG7_1', 'figureG7_1.png'); }

                create() {
                    this.cameras.main.setBackgroundColor('#ffffff'); 
                    this.currentQuestionIndex = 0;
                    this.questionObjects = []; 

                    this.scoreText = this.add.text(this.sys.game.config.width - 20, 20, '', { fontFamily: 'Inter', fontSize: '16px', color: '#4b5563', align: 'right' }).setOrigin(1, 0);
                    this.questionObjects.push(this.scoreText);

                    if (gameMode === 'exam') {
                        this.timerText = this.add.text(this.sys.game.config.width - 20, 45, 'Time: 00:00', { fontFamily: 'Inter', fontSize: '16px', color: '#4b5563', align: 'right' }).setOrigin(1, 0);
                        this.questionObjects.push(this.timerText);
                        this.time.addEvent({ delay: 1000, callback: this.updateTimer, callbackScope: this, loop: true });
                    }

                    this.displayQuestion();
                }
                
                updateTimer() {
                    const elapsedMs = new Date() - examStartTime;
                    const seconds = Math.floor((elapsedMs / 1000) % 60).toString().padStart(2, '0');
                    const minutes = Math.floor(elapsedMs / 60000).toString().padStart(2, '0');
                    this.timerText.setText(`Time: ${minutes}:${seconds}`);
                }

                displayQuestion() {
                    this.questionObjects.forEach(obj => obj.destroy());
                    this.questionObjects = [this.scoreText];
                    if (this.timerText) this.questionObjects.push(this.timerText);


                    if (this.currentQuestionIndex >= allQuestions.length) {
                        this.showEndScreen();
                        return;
                    }
                    
                    this.scoreText.setText(`Score: ${overallScore.correct} / ${overallScore.attempted}`);

                    const question = allQuestions[this.currentQuestionIndex];
                    const canvasWidth = this.sys.game.config.width;

                    const textStyle = { fontFamily: 'Inter', fontSize: '18px', color: '#1f2937', align: 'left', wordWrap: { width: canvasWidth - 40 } };
                    const idStyle = { fontFamily: 'Inter', fontSize: '14px', color: '#4b5563' };
                    const optionStyle = { fontFamily: 'Inter', fontSize: '16px', color: '#111827', backgroundColor: '#f9fafb', padding: { x: 10, y: 5 }, wordWrap: { width: canvasWidth - 60 }, fixedWidth: canvasWidth - 40, };

                    let yPos = 20;
                    const progressText = this.add.text(20, yPos, `Question ${this.currentQuestionIndex + 1} of ${allQuestions.length}`, idStyle);
                    yPos += 25;
                     if(gameMode === 'study'){ // Only show ID in study mode
                        const idText = this.add.text(20, yPos, `ID: ${question.id || 'N/A'}`, idStyle);
                        this.questionObjects.push(idText);
                        yPos += 30;
                    }
                    const qText = this.add.text(20, yPos, question.question || '[Missing Question Text]', textStyle);
                    yPos += qText.height + 20;
                    
                    this.questionObjects.push(progressText, qText);

                    if (question.image) {
                        const img = this.add.image(canvasWidth / 2, yPos + 100, 'figureG7_1').setScale(0.5);
                        yPos += img.displayHeight + 20;
                        this.questionObjects.push(img);
                    }

                    (question.options || []).forEach(optionText => {
                        const option = this.add.text(20, yPos, optionText || '', optionStyle)
                            .setInteractive({ useHandCursor: true });
                        option.on('pointerdown', () => this.handleOptionClick(option, question));
                        yPos += option.height + 15;
                        this.questionObjects.push(option);
                    });
                }

                handleOptionClick(selectedOption, question) {
                     const selectedAnswer = selectedOption.text;
                    const correctAnswer = question.answer;
                    
                    overallScore.attempted++;
                    if(gameMode === 'study') chapterScores[question.sourceChapter].attempted++;

                    this.questionObjects.filter(o => o.type === 'Text' && question.options.includes(o.text)).forEach(o => o.disableInteractive());
                    
                    if (selectedAnswer === correctAnswer) {
                        overallScore.correct++;
                        if(gameMode === 'study') chapterScores[question.sourceChapter].correct++;
                        selectedOption.setStyle({ color: '#ffffff', backgroundColor: '#22c55e' });
                    } else {
                        missedQuestions.push({ question: question.question, yourAnswer: selectedAnswer, correctAnswer: correctAnswer, id: question.id });
                        selectedOption.setStyle({ color: '#ffffff', backgroundColor: '#ef4444' });
                        this.questionObjects.find(o => o.text === correctAnswer).setStyle({ color: '#ffffff', backgroundColor: '#22c55e' });
                    }
                    
                    this.scoreText.setText(`Score: ${overallScore.correct} / ${overallScore.attempted}`);

                    const nextBtn = this.add.text(this.sys.game.config.width / 2, this.sys.game.config.height - 40, 'Next Question', { fontSize: '20px', color: '#ffffff', backgroundColor: '#3b82f6', padding: {x: 15, y: 10}})
                        .setOrigin(0.5)
                        .setInteractive({ useHandCursor: true });
                    nextBtn.on('pointerdown', () => {
                        this.currentQuestionIndex++;
                        this.displayQuestion();
                    });
                    this.questionObjects.push(nextBtn);
                }

                showEndScreen() {
                     displayFinalScore();
                     this.game.destroy(true);
                }
            }
            
            // ----- GAME LOGIC FUNCTIONS -----
            function startGame() {
                allQuestions = [];
                missedQuestions = [];
                chapterScores = {};
                overallScore = { correct: 0, attempted: 0 };

                if (gameMode === 'study') {
                    const selectedChapters = Array.from(document.querySelectorAll('input[name="chapter"]:checked')).map(cb => parseInt(cb.value));
                    if (selectedChapters.length === 0) return;
                    
                    CHAPTER_DATA.forEach(ch => {
                        if (selectedChapters.includes(ch.id)) {
                            chapterScores[ch.varName] = { title: `Chapter ${ch.id}: ${ch.title}`, correct: 0, attempted: 0 };
                            ch.data.questions.forEach(q => allQuestions.push({ ...q, sourceChapter: ch.varName }));
                        }
                    });
                    if (randomizeCheckbox.checked) allQuestions.sort(() => Math.random() - 0.5);
                
                } else if (gameMode === 'exam') {
                    examStartTime = new Date();
                    const fullPool = CHAPTER_DATA.map(ch => ch.data.questions).flat();
                    fullPool.sort(() => Math.random() - 0.5); // Shuffle
                    allQuestions = fullPool.slice(0, 35);
                }
                
                selectionContainer.classList.add('hidden');
                gameContainer.classList.remove('hidden');

                const config = { type: Phaser.AUTO, width: 700, height: 800, parent: 'game-container', scene: GameScene };
                gameInstance = new Phaser.Game(config);
            }

            function displayFinalScore() {
                gameContainer.innerHTML = ''; 
                gameContainer.classList.add('hidden');
                
                let scoreHTML = ``;
                if(gameMode === 'exam'){
                    const elapsedMs = new Date() - examStartTime;
                    const seconds = Math.floor((elapsedMs / 1000) % 60).toString().padStart(2, '0');
                    const minutes = Math.floor(elapsedMs / 60000);
                    const timeString = `${minutes} minute${minutes !== 1 ? 's' : ''} and ${seconds} second${seconds !== 1 ? 's' : ''}`;

                    const passed = overallScore.correct >= 26;
                    scoreHTML += `<h1 class="text-3xl font-bold text-center mb-2">Practice Exam Complete!</h1>`;
                    scoreHTML += `<p class="text-center text-lg mb-6 ${passed ? 'text-green-500' : 'text-red-500'} font-semibold">${passed ? 'Result: PASS' : 'Result: FAIL'}</p>`;
                     scoreHTML += `<div class="bg-gray-100 dark:bg-gray-700 rounded-lg p-4 mb-6 text-center">
                                    <h2 class="text-xl font-bold">Final Score</h2>
                                    <p class="text-3xl font-light mt-2">${overallScore.correct} / 35</p>
                                    <p class="text-md text-gray-500 dark:text-gray-400 mt-2">Time Taken: ${timeString}</p>
                                  </div>`;
                } else { // Study Mode
                    scoreHTML = `<h1 class="text-2xl md:text-3xl font-bold text-center mb-6">Study Session Complete!</h1>`;
                    const percentage = allQuestions.length === 0 ? 0 : Math.round((overallScore.correct / allQuestions.length) * 100);
                    scoreHTML += `<div class="bg-gray-100 dark:bg-gray-700 rounded-lg p-4 mb-6 text-center">
                                    <h2 class="text-xl font-bold">Overall Score</h2>
                                    <p class="text-3xl font-light mt-2">${overallScore.correct} / ${allQuestions.length} (${percentage}%)</p>
                                  </div>`;
                    if (Object.keys(chapterScores).length > 1) {
                        scoreHTML += `<h2 class="text-xl font-bold mb-4">Chapter Breakdown</h2><div class="space-y-3 mb-6">`;
                        for (const key in chapterScores) {
                            const score = chapterScores[key];
                            const chapPercentage = score.attempted === 0 ? 0 : Math.round((score.correct / score.attempted) * 100);
                            scoreHTML += `<div class="flex justify-between items-center bg-gray-100 dark:bg-gray-700 p-3 rounded-lg">
                                            <span class="font-semibold">${score.title}</span>
                                            <span>${score.correct} / ${score.attempted} (${chapPercentage}%)</span>
                                          </div>`;
                        }
                        scoreHTML += `</div>`;
                    }
                }

                // Missed Questions (for both modes)
                if (missedQuestions.length > 0) {
                    scoreHTML += `<h2 class="text-xl font-bold mb-4">Review Missed Questions</h2><div class="space-y-4">`;
                    missedQuestions.forEach(q => {
                        scoreHTML += `<div class="bg-red-100 dark:bg-red-900/20 border-l-4 border-red-500 p-4 rounded-r-lg">
                                        <p class="font-semibold text-gray-800 dark:text-gray-200">${q.id}: ${q.question}</p>
                                        <p class="mt-2 text-red-700 dark:text-red-400"><span class="font-bold">Your Answer:</span> ${q.yourAnswer}</p>
                                        <p class="mt-1 text-green-700 dark:text-green-400"><span class="font-bold">Correct Answer:</span> ${q.correctAnswer}</p>
                                      </div>`;
                    });
                    scoreHTML += `</div>`;
                }

                scoreHTML += `<button id="restart-btn" class="w-full mt-8 bg-blue-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-blue-700">Return to Main Menu</button>`;
                scoreContainer.innerHTML = scoreHTML;
                scoreContainer.classList.remove('hidden');
                document.getElementById('restart-btn').addEventListener('click', () => location.reload());
            }

            // ----- EVENT LISTENERS -----
            function selectMode(mode) {
                gameMode = mode;
                startBtn.disabled = false;
                startBtn.textContent = mode === 'study' ? 'Start Study Session' : 'Start Practice Exam';
                if (mode === 'study') {
                    modeStudyBtn.classList.add('selected');
                    modeExamBtn.classList.remove('selected');
                    studyOptions.classList.remove('hidden');
                    examOptions.classList.add('hidden');
                    startBtn.disabled = document.querySelectorAll('input[name="chapter"]:checked').length === 0;
                } else { // exam
                    modeExamBtn.classList.add('selected');
                    modeStudyBtn.classList.remove('selected');
                    examOptions.classList.remove('hidden');
                    studyOptions.classList.add('hidden');
                }
            }
            
            modeStudyBtn.addEventListener('click', () => selectMode('study'));
            modeExamBtn.addEventListener('click', () => selectMode('exam'));
            chapterList.addEventListener('change', () => {
                if(gameMode === 'study') {
                    startBtn.disabled = document.querySelectorAll('input[name="chapter"]:checked').length === 0;
                }
            });
            startBtn.addEventListener('click', startGame);

            // ----- START THE APP -----
            initializeChapterSelection();
        }, 50);
        });
    </script>
</body>
</html>

